var addMessage,fetchChat,removeAllChats;fetchChat=function(e,r){return e.collection("chat",function(e,t){return e?(logError(e),r(e,null)):t.find({},{limit:50}).toArray(function(e,t){return e?r(e):r(e,t)})})},addMessage=function(e,r,t,o,n,c){return e.collection("chat",function(e,i){return e?(logError(e),c(e,null)):i.insert({color:r,userid:t,text:n,twitterId:o},c)})},removeAllChats=function(e,r){return e.collection("chat",function(t,o){return t?logError(t):o.remove({},{},function(t,o){return t||console.log("Removed "+o+" chats"),r(t,e)})})};var assignUserColor,colors,fetchOrCreateUserColor,usedColors,_;_=require("underscore"),colors=["red","blue","yellow","black"],usedColors={},_.each(colors,function(e){return console.log(e),usedColors[e]=null}),assignUserColor=function(){var e;return e=_.find(colors,function(e){return null===usedColors[e]}),usedColors[e]=!0,e},fetchOrCreateUserColor=function(e,r,t,o){return e.collection("user_colors",function(e,n){return e?(logError(e),o(e,null)):n.findAndModify({userid:""+r,twitterId:""+t},[["_id","asc"]],{$setOnInsert:{userid:""+r,twitterId:""+t}},{"new":!0,upsert:!0},function(e,r){return e?(logError(e),o(e,null)):o(null,r)})})},exports.config={consumerKey:"B2xbPGrR4Hpt4dgKeQE9g",consumerSecret:"8l1268xONGV2cm4dOwBmaTnRwHbCzjRueekk3FqsY"};var logError,mongoConnect;logError=function(e){return console.log("ERROR: "+JSON.stringify(e,null,2))},mongoConnect=function(e){var r,t,o,n,c,i,s;return console.log("db connected"),t=require("mongodb").Db,r=require("mongodb").Connection,o=require("mongodb").Server,c=process.env.MONGO_NODE_DRIVER_HOST?process.env.MONGO_NODE_DRIVER_HOST:"localhost",i=process.env.MONGO_NODE_DRIVER_PORT?process.env.MONGO_NODE_DRIVER_PORT:r.DEFAULT_PORT,s={safe:!0,journal:!0,auto_reconnect:!0,poolSize:15},n=new t("canned",new o(c,i),s),n.open(e)},exports.routes={index:function(e,r){var t,o;return o=fetchOrCreateUserid(e,r),t=e.query.user,t?(console.log("twitterId: "+t),fetchOrCreateUserColor(global.db,o,t,function(e,n){return e?logError(e):r.render("index",{title:"Canned",color:n,userid:o,twitterId:t})})):r.redirect(301,"/login")},reset:function(e,r){return removeAllChats(global.db,function(e){return e?logError(e):r.redirect(301,"/")})}},exports.sockets={connected:function(e){return console.log("sockets connected"),e.on("login",function(r,t){return fetchOrCreateUserColor(global.db,r,t,function(o,n){return o?logError(o):fetchChat(global.db,function(o,c){return o?logError(o):(e.emit("welcome",{userid:r,twitterId:t,color:n,chat:c}),e.broadcast.emit("joined",{userid:r,twitterId:t,color:n}))})})}),e.on("chat",function(r){return e.broadcast.emit("chat",r),addMessage(global.db,r.color,r.userid,r.twitterId,r.text,function(e,r){return console.log("wrote "+r)})}),e.on("typed",function(r){return e.broadcast.emit("typed",r)})}};var TwitterAPI,TwitterLogin,__bind=function(e,r){return function(){return e.apply(r,arguments)}};TwitterAPI=require("node-twitter-api"),exports.TwitterLogin=TwitterLogin=function(){function e(e,r){this.receiveCredentials=__bind(this.receiveCredentials,this),this.receiveAccessToken=__bind(this.receiveAccessToken,this),this.receiveRequestToken=__bind(this.receiveRequestToken,this),this.credentials={},this.api=new TwitterAPI({consumerKey:e,consumerSecret:r,callback:"http://localhost:3000/oauth-callback"})}return e.prototype.loginAction=function(e,r){return this.api.getRequestToken(function(e){return function(){var t;return t=e.receiveRequestToken.apply(e,arguments),t?r.redirect(301,t):void 0}}(this))},e.prototype.callbackAction=function(e,r){return this.api.getAccessToken(this.credentials.request.token,this.credentials.request.tokenSecret,e.query.oauth_verifier,function(e){return function(){return e.receiveAccessToken.apply(e,arguments),e.api.verifyCredentials(e.credentials.access.token,e.credentials.access.tokenSecret,function(){var t;return t=e.receiveCredentials.apply(e,arguments),r.redirect(301,"/?user="+t.screen_name)})}}(this))},e.prototype.receiveRequestToken=function(e,r,t){return e?console.log("Error getting OAuth request token : "+e):(this.credentials.request={token:r,tokenSecret:t},"https://api.twitter.com/oauth/authenticate?oauth_token="+this.credentials.request.token)},e.prototype.receiveAccessToken=function(e,r,t){return e?console.log(e):this.credentials.access={token:r,tokenSecret:t}},e.prototype.receiveCredentials=function(e,r){return e?console.log("something was wrong with either accessToken or accessTokenSecret"):(console.log(r.screen_name),this.credentials.data=r,r)},e}();var fetchOrCreateUserid;fetchOrCreateUserid=function(e,r){var t;return t=e.cookies.userid,t||(t=100*Date.now()+Math.floor(100*Math.random()),r.cookie("userid",t,{maxAge:10368e6})),t};