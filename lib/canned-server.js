var addMessage,fetchChat,removeAllChats;fetchChat=function(r,o){return r.collection("chat",function(r,e){return r?(logError(r),o(r,null)):e.find({},{limit:50}).toArray(function(r,e){return r?o(r):o(r,e)})})},addMessage=function(r,o,e,n,t){return r.collection("chat",function(r,c){return r?(logError(r),t(r,null)):c.insert({color:o,userid:e,text:n},t)})},removeAllChats=function(r,o){return r.collection("chat",function(e,n){return e?logError(e):n.remove({},{},function(e,n){return e||console.log("Removed "+n+" chats"),o(e,r)})})};var assignUserColor,colors,fetchOrCreateUserColor,usedColors,_;_=require("underscore"),colors=["red","blue","yellow","black"],usedColors={},_.each(colors,function(r){return console.log(r),usedColors[r]=null}),assignUserColor=function(){var r;return r=_.find(colors,function(r){return null===usedColors[r]}),usedColors[r]=!0,r},fetchOrCreateUserColor=function(r,o,e){return r.collection("user_colors",function(r,n){return r?(logError(r),e(r,null)):n.findOne({userid:o},function(r,t){return r?(logError(r),e(r,null)):(console.log(t),t?e(null,t.color):(t=assignUserColor(),n.insert({userid:o,color:t},function(){}),r?logError(r):e(null,t.color)))})})};var logError,mongoConnect;logError=function(r){return console.log("ERROR: "+JSON.stringify(r,null,2))},mongoConnect=function(r){var o,e,n,t,c,l,u;return console.log("db connected"),e=require("mongodb").Db,o=require("mongodb").Connection,n=require("mongodb").Server,c=process.env.MONGO_NODE_DRIVER_HOST?process.env.MONGO_NODE_DRIVER_HOST:"localhost",l=process.env.MONGO_NODE_DRIVER_PORT?process.env.MONGO_NODE_DRIVER_PORT:o.DEFAULT_PORT,u={safe:!0,journal:!0,auto_reconnect:!0,poolSize:15},t=new e("canned",new n(c,l),u),t.open(r)};var render;render=function(r,o,e){return r.render("index",{title:"Canned",color:e,userid:o})},exports.routes={index:function(r,o){var e;return e=fetchOrCreateUserid(r,o),mongoConnect(function(r,n){return r?logError(r):fetchOrCreateUserColor(n,e,function(r,n){return r?logError(r):render(o,e,n)})})},reset:function(r,o){return mongoConnect(function(r,e){return r?logError(r):removeAllChats(e,function(r){return r?logError(r):o.redirect(301,"/")})})}},mongoConnect(function(r,o){return exports.sockets={connected:function(r){return console.log("connected"),r.on("login",function(e){return fetchOrCreateUserColor(o,e,function(n,t){return n?logError(n):fetchChat(o,function(o,n){return o?logError(o):(r.emit("welcome",{userid:e,color:t,chat:n}),r.broadcast.emit("joined",{userid:e,color:t}))})})}),r.on("chat",function(e){return r.broadcast.emit("chat",e),addMessage(o,e.color,e.userid,e.text,function(r,o){return console.log("wrote "+o)})}),r.on("typed",function(o){return r.broadcast.emit("typed",o)})}}});var fetchOrCreateUserid;fetchOrCreateUserid=function(r,o){var e;return e=r.cookies.userid,e||(e=100*Date.now()+Math.floor(100*Math.random()),o.cookie("userid",e,{maxAge:10368e6})),e};