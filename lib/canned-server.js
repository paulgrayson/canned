var addMessage,fetchChat;fetchChat=function(o,r){return o.collection("chat",function(o,e){return o?(logError(o),r(o,null)):e.find({},{limit:50}).toArray(function(o,e){return o?r(o):r(o,e)})})},addMessage=function(o,r,e,n,t){return o.collection("chat",function(o,c){return o?(logError(o),t(o,null)):c.insert({color:r,userid:e,text:n},t)})};var assignUserColor,colors,fetchOrCreateUserColor,usedColors,_;_=require("underscore"),colors=["red","blue","yellow","black"],usedColors={},_.each(colors,function(o){return console.log(o),usedColors[o]=null}),assignUserColor=function(){var o;return o=_.find(colors,function(o){return null===usedColors[o]}),usedColors[o]=!0,o},fetchOrCreateUserColor=function(o,r,e){return o.collection("user_colors",function(o,n){return o?(logError(o),e(o,null)):n.findOne({userid:r},function(o,t){return o?(logError(o),e(o,null)):(console.log(t),t?e(null,t.color):(t=assignUserColor(),n.insert({userid:r,color:t},function(){}),o?logError(o):e(null,t.color)))})})};var logError,mongoConnect;logError=function(o){return console.log("error: "+JSON.stringify(o,null,2))},mongoConnect=function(o){var r,e,n,t,c,l,u;return console.log("db connected"),e=require("mongodb").Db,r=require("mongodb").Connection,n=require("mongodb").Server,c=process.env.MONGO_NODE_DRIVER_HOST?process.env.MONGO_NODE_DRIVER_HOST:"localhost",l=process.env.MONGO_NODE_DRIVER_PORT?process.env.MONGO_NODE_DRIVER_PORT:r.DEFAULT_PORT,u={auto_reconnect:!0,poolSize:15},t=new e("canned",new n(c,l,u),{}),t.open(o)};var fetchOrCreateUserid,render;fetchOrCreateUserid=function(o,r){var e;return e=o.cookies.userid,e||(e=100*Date.now()+Math.floor(100*Math.random()),r.cookie("userid",e,{maxAge:10368e6})),e},render=function(o,r,e){return o.render("index",{title:"Canned",color:e,userid:r})},exports.routes={index:function(o,r){var e;return e=fetchOrCreateUserid(o,r),mongoConnect(function(o,n){return o?logError(o):fetchOrCreateUserColor(n,e,function(o,n){return o?logError(o):render(r,e,n)})})}},mongoConnect(function(o,r){return exports.sockets={connected:function(o){return console.log("connected"),o.on("login",function(e){return console.log("Login: "+e),fetchOrCreateUserColor(r,e,function(n,t){return n?logError(n):(console.log("color "+t),fetchChat(r,function(r,n){return r?logError(r):(console.log(n),o.emit("welcome",{userid:e,color:t,chat:n}),o.broadcast.emit("joined",{userid:e,color:t}))}))})}),o.on("chat",function(e){return console.log(e),o.broadcast.emit("chat",e),addMessage(r,e.color,e.userid,e.text,function(o,r){return console.log("wrote "+r)})}),o.on("typed",function(r){return console.log(r),o.broadcast.emit("typed",r)})}}});